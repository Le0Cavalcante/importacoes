<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Alertas de Cobran√ßa</title>
  <script>
    let alertasResolvidos = JSON.parse(localStorage.getItem('alertasResolvidos') || '{}');
    let instituicoes = JSON.parse(localStorage.getItem('instituicoes')) || [
      { nome: "CEBAMA", dias_para_cobrar: 30, vencimentos: [1,5,6,7,8,9,10,12,13,15,20,21,25,26,30] },
      { nome: "CEBAMA KIDS", dias_para_cobrar: 1, vencimentos: [1,5,6,7,8,9,10,12,13,15,20,21,25,26,30] },
      { nome: "CARITAS", dias_para_cobrar: 30, vencimentos: [7,8,10,12,14,15,20,25,27,30] },
      { nome: "ARTECEB", dias_para_cobrar: 3, vencimentos: [10,11,12,14,17,20,21,24,28,30] },
      { nome: "BELO JARDIM", dias_para_cobrar: 15, vencimentos: [5,6,10,15,20,25,30] },
      { nome: "FACDO", dias_para_cobrar: 5, vencimentos: [10,20] },
    ];

    function salvarInstituicoes() {
      localStorage.setItem('instituicoes', JSON.stringify(instituicoes));
    }

    function gerarAlertas() {
      const dataSelecionada = document.getElementById('dataFiltro').value;
      const filtroInstituicao = document.getElementById('instituicaoFiltro').value;
      const hoje = dataSelecionada ? new Date(dataSelecionada) : new Date();
      const ano = 2025;
      const alertasHoje = [];

      atualizarSelects();

      instituicoes.forEach(inst => {
        for (let mes = 0; mes < 12; mes++) {
          inst.vencimentos.forEach(dia => {
            const venc = new Date(ano, mes, dia);
            if (venc.getMonth() !== mes) return;

            const alerta = new Date(venc);
            alerta.setDate(alerta.getDate() + inst.dias_para_cobrar);

            if (
              alerta.getDate() === hoje.getDate() &&
              alerta.getMonth() === hoje.getMonth() &&
              alerta.getFullYear() === hoje.getFullYear()
            ) {
              const id = `${inst.nome}-${venc.toLocaleDateString()}`;
              if (!alertasResolvidos[id]) {
                if (!filtroInstituicao || filtroInstituicao === inst.nome) {
                  alertasHoje.push({
                    id,
                    instituicao: inst.nome,
                    vencimento: venc.toLocaleDateString()
                  });
                }
              }
            }
          });
        }
      });

      const lista = document.getElementById('alertas');
      lista.innerHTML = '';

      if (alertasHoje.length === 0) {
        lista.innerHTML = '<li>Sem alertas para esta data ou todos j√° resolvidos.</li>';
        document.getElementById('marcarTodos').style.display = 'none';
      } else {
        document.getElementById('marcarTodos').style.display = 'inline-block';
        alertasHoje.forEach(a => {
          const li = document.createElement('li');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = a.id;
          checkbox.addEventListener('change', () => {
            alertasResolvidos[a.id] = true;
            localStorage.setItem('alertasResolvidos', JSON.stringify(alertasResolvidos));
            gerarAlertas();
          });
          li.appendChild(checkbox);
          const label = document.createElement('label');
          label.htmlFor = a.id;
          label.textContent = ` üîî ${a.instituicao} - Cobrar t√≠tulo com vencimento em ${a.vencimento}`;
          li.appendChild(label);
          lista.appendChild(li);
        });
        if (!dataSelecionada && !filtroInstituicao) notificar(alertasHoje);
      }
    }

    function atualizarSelects() {
      const selects = [
        document.getElementById('instituicaoFiltro'),
        document.getElementById('alterarInstituicao'),
        document.getElementById('vencInstituicao')
      ];
      selects.forEach(select => {
        const valorSelecionado = select.value;
        select.innerHTML = '<option value="">Todas</option>';
        instituicoes.forEach(i => {
          const opt = document.createElement('option');
          opt.value = i.nome;
          opt.textContent = i.nome;
          if (i.nome === valorSelecionado) opt.selected = true;
          select.appendChild(opt);
        });
      });
    }

    function adicionarInstituicao() {
      const nome = document.getElementById('novaInstituicaoNome').value.trim();
      const prazo = parseInt(document.getElementById('novaInstituicaoPrazo').value);
      const vencimentos = document.getElementById('novaInstituicaoVenc').value.trim().split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 31);

      if (nome && !isNaN(prazo) && vencimentos.length > 0) {
        instituicoes.push({ nome, dias_para_cobrar: prazo, vencimentos });
        salvarInstituicoes();
        alert(`Institui√ß√£o ${nome} adicionada com sucesso!`);
        gerarAlertas();
      } else {
        alert('Preencha todos os campos corretamente.');
      }
    }

    function marcarTodosComoResolvidos() {
      document.querySelectorAll('#alertas input[type="checkbox"]').forEach(cb => {
        alertasResolvidos[cb.id] = true;
      });
      localStorage.setItem('alertasResolvidos', JSON.stringify(alertasResolvidos));
      gerarAlertas();
    }

    function alterarPrazo() {
      const instNome = document.getElementById('alterarInstituicao').value;
      const novoPrazo = parseInt(document.getElementById('novoPrazo').value);
      const inst = instituicoes.find(i => i.nome === instNome);
      if (inst && !isNaN(novoPrazo)) {
        inst.dias_para_cobrar = novoPrazo;
        salvarInstituicoes();
        alert(`Prazo de cobran√ßa atualizado para ${novoPrazo} dias em ${instNome}`);
        gerarAlertas();
      }
    }

    function adicionarVencimento() {
      const instNome = document.getElementById('vencInstituicao').value;
      const novoVenc = parseInt(document.getElementById('novoVenc').value);
      const inst = instituicoes.find(i => i.nome === instNome);
      if (inst && !isNaN(novoVenc) && !inst.vencimentos.includes(novoVenc)) {
        inst.vencimentos.push(novoVenc);
        inst.vencimentos.sort((a, b) => a - b);
        salvarInstituicoes();
        alert(`Novo vencimento (${novoVenc}) adicionado para ${instNome}`);
        gerarAlertas();
      }
    }

    function notificar(alertas) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        const corpo = alertas.map(a => `${a.instituicao} - venc. ${a.vencimento}`).join('\n');
        new Notification("üîî Alertas de Cobran√ßa de Hoje", {
          body: corpo,
          icon: "https://cdn-icons-png.flaticon.com/512/727/727399.png"
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(perm => {
          if (perm === "granted") notificar(alertas);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      gerarAlertas();
      setInterval(gerarAlertas, 30 * 60 * 1000);
      document.getElementById('marcarTodos').addEventListener('click', marcarTodosComoResolvidos);
      document.getElementById('dataFiltro').addEventListener('change', gerarAlertas);
      document.getElementById('instituicaoFiltro').addEventListener('change', gerarAlertas);
      document.getElementById('btnAlterarPrazo').addEventListener('click', alterarPrazo);
      document.getElementById('btnAdicionarVenc').addEventListener('click', adicionarVencimento);
      document.getElementById('btnAdicionarInstituicao').addEventListener('click', adicionarInstituicao);
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; color: #333; padding: 20px; }
    h1 { color: #222; }
    ul { padding-left: 20px; }
    li { margin: 8px 0; list-style: none; }
    label { margin-left: 8px; }
    button { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; }
    button:hover { background: #0056b3; }
    .filtros, .configuracoes { margin-bottom: 15px; }
    select, input[type="date"], input[type="number"], input[type="text"] { padding: 5px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>üìÜ Alertas de Cobran√ßa - <span id="dataHoje"></span></h1>
  <div class="filtros">
    <label for="dataFiltro">üìÖ Filtrar por data:</label>
    <input type="date" id="dataFiltro" />

    <label for="instituicaoFiltro">üè´ Filtrar por institui√ß√£o:</label>
    <select id="instituicaoFiltro"></select>
  </div>

  <div class="configuracoes">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>
    <div>
      <label>Alterar prazo de cobran√ßa: </label>
      <select id="alterarInstituicao"></select>
      <input type="number" id="novoPrazo" placeholder="dias" min="0" />
      <button id="btnAlterarPrazo">Atualizar</button>
    </div>
    <div style="margin-top: 10px;">
      <label>Adicionar novo vencimento: </label>
      <select id="vencInstituicao"></select>
      <input type="number" id="novoVenc" placeholder="dia do m√™s" min="1" max="31" />
      <button id="btnAdicionarVenc">Adicionar</button>
    </div>
    <div style="margin-top: 10px;">
      <label>Nova institui√ß√£o: </label>
      <input type="text" id="novaInstituicaoNome" placeholder="Nome da institui√ß√£o" />
      <input type="number" id="novaInstituicaoPrazo" placeholder="Prazo (dias)" />
      <input type="text" id="novaInstituicaoVenc" placeholder="Vencimentos (ex: 5,10,20)" />
      <button id="btnAdicionarInstituicao">Adicionar Institui√ß√£o</button>
    </div>
  </div>

  <ul id="alertas"></ul>
  <button id="marcarTodos" style="display: none;">‚úÖ Marcar todos como resolvidos</button>
  <script>
    document.getElementById("dataHoje").textContent = new Date().toLocaleDateString();
  </script>
</body>
</html>
